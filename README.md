# MC53-ME38_BVE_VM
- 本開発品は主に主に国鉄型SELD式車両向け等のマスコン、ブレーキ弁などの入力操作と速度計や電圧計のメーターなどの外部表示器をBVEと連動させるものです。

> [!TIP]
>- BVE5.8と6の両方に対応
>- Arduino Microを使用し、HIDキーボード機能を利用したキー入力と、シリアルポートを介した機器連動を同時に実現します。
>- BVEだけではなく、一部の鉄道シミュレーターなどの操作が可能(メーター類は不動)
>- 部品の配線やポテンショの追加改造のみで実装可能
>- 付属の[調整ソフト](https://github.com/GraphTechKEN/MC53_ME38_BVE_VM/releases/)で、ブレーキ弁角度や速度計補償などの細かい設定も可能
>- [こちら](https://github.com/GraphTechKEN/115-1000_Display)の115系1000番台向け表示灯拡張基板を製作し接続すると、メーターパネルの表示灯(一部)も連動可能に。こちらを利用すると、気合と根性で圧力計やATS-P機器などとも連動できるようになるかもしれません。
>- ブレーキ弁へはポテンショ(可変抵抗)を工夫(ローラーやギヤ機構を付加)して取付けます。
>- 動作確認済みマスコン：MC37A、MC53、MC22、MC54、小田急1000形未更新
>- 動作確認済みブレーキ弁：ME38、ME40、ME48、ME50、ME62、ME72
>- 動作確認済みメーター：SR35、SR36 (Typ.10mA品)、小田急1000形未更新車は2kΩを直列に挟むこと

## 製作方法
~~実装済基板は[こちら](http://graphtechken.booth.pm/items/6223832)~~ お問い合わせ可  
1. 部品表は[こちら](PartsList.xlsx)
2. 基板は秋月電子製片面紙エポキシ・ユニバーサル基板　Ａの小タイプ(AE-5)またはサンハヤト製(ICB-97 1.2mm またはICB-97B 1.6mm)を推奨します。
3. 使用マイコンはArduino MicroのArduino純正品です。それ以外では正しく動作しないかピン配置が異なります。ご注意ください。
4. 10kΩの集合抵抗は8素子タイプで、コモンを1とした場合は2番目と3番目のピンをカットしてください。
5. こちらの[回路図通り](ME38_MC53_Pedal_SWBox_DG_VM_V4.2.0.6.pdf)に配線[完全版(実態配線図)](ME38_MC53_Pedal_SWBox_DG_VM_V4.2.0.6.png)します。(完全版は下のⅰとⅱ両方に対応します、青線がはんだ面、赤線がジャンパワイヤーです)  
   1. [標準版(実態配線図)](ME38_MC53_Pedal_SWBox_DG_VM_V4.2.0.6_Normal.png)  
      基本的にはこちらの構成を推奨いたします。  
   2. [軽量版(実態配線図)](ME38_MC53_Pedal_SWBox_DG_VM_V4.2.0.6_Simple.png)  
      MCP4725(DA変換)およびMCP3008(AD変換)を廃止したエコノミー版です。PWM制御とマイコンによる直接制御となりますが、後の配線ショートや過電圧印可によってマイコンを破損させた場合のリスクが大きいです。また、PWMは高周波を発生させるため、メーターのデリケートな軸受けやバネが共振して寿命を早める可能性があります。こちらを使用する場合は、#define SIMPLE をスケッチで定義してコンパイルしてください。
7. 接続コネクタはDF1Bで記載していますが、2.54mmピッチであれば何でも構いません。他にはXHコネクタ(ベース付きポストサイド型)があります。シンプルなピンヘッダ(オスL型)でも接続出来ますが、不意な配線抜けがリスクです。もちろん直接配線しても問題ありませんが、作業性を考慮するとコネクタ化を推奨します。
8. Arduino MicroとMCP4725モジュールにはロングピンソケット(分割ロングピンソケット42P推奨、分割して使用)、MCP3008とMCP23S17にはそれぞれICソケット(14pin、28pin)を用いると、万が一ICを破損させてしまった時の交換が容易です。
9. AE-MCP4725の基板裏面はSDAとSCLのプルアップのみハンダでジャンパー接続します。A0はピンに配線しています。(ジャンパーを忘れると正常動作しません)
10. Arduino IDEには、Adafruit MCP23017 Arduino Library と Adafruit_MCP4725 Arduino Library を導入してください。
11. メーター調整用可変抵抗は、実体配線図の向きで取り付けると、回転方向がメーターと一致します。
12. ブレーキ弁の回転方向とシミュレータ上のブレーキ方向が逆の場合は、1番ピン+5Vと3番ピンGndを逆に接続してください。  
   ![実態配線図](https://github.com/GraphTechKEN/MC53_ME38_BVE_VM/blob/main/ME38_MC53_Pedal_SWBox_DG_VM_V4.2.0.6.png)

> [!WARNING]
>- 配線が1本でも異なると所望の動作はしません。SPIとI2Cのバスライン、+5VとGNDのショートは特に注意してください。
>- 本開発品によるいかなる破損や不具合等が生じても当方はいかなる責任を負いかねますので、ご了承ください。
>- BU0836を使用した外部機器とは相性不具合を起こす場合があります。ご注意ください。

> [!TIP]
>- Serial1出力と5V出力は、表示灯類など拡張用のために用います。
>- Serial1出力(Tx)：USBからのSerial電文をそのままSerial1から他基板へ渡します。
>- Serial1入力(Rx):他基板(表示基板など)から本基板へ信号を渡します。
>- 331e線が実車ではGndですが、その配線ですと力行しない限りレバーサの前進(4線)と後進(5線)が判別できないため、331h線をGndとし、331e線を1段目に付け替えています。

## BVEとの連動方法
> [こちら](https://github.com/GraphTechKEN/SerialOutputEx)のSerialOutputExを参照してください。

## 謝辞
本開発品はツナギ図 laboratory(ED67900-5様代表ほか)の出版冊子[実物部品を使った運転シミュレータのつくりかた | ](https://booth.pm/ja/items/1756291)を参考にしております。  
この場を借りて御礼申し上げます。
本開発品は[まさき氏 X](https://x.com/ME48GEB1)により監修いただきました。この場を借りて御礼申し上げます。
本開発品は[万葉超音波温泉クハ115-1106](https://x.com/manyoonsen)の実車挙動を参考にさせていただきました。この場を借りて御礼申し上げます。

